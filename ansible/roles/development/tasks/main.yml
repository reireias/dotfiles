---
- name: set default asdf version
  set_fact:
    asdf_version: "v0.14.1"
  when: ansible_facts['os_family'] == 'Debian'

- name: install packages for asdf
  apt:
    name:
      - zlib1g-dev
      - libbz2-dev
      - libreadline-dev
      - libssl-dev
      - libsqlite3-dev
      - libffi-dev
      - git
      - bash
      - curl
  become: true
  when: ansible_facts['os_family'] == 'Debian'

- name: get latest asdf version  # noqa: command-instead-of-module
  shell: |
    set -o pipefail
    curl -s https://api.github.com/repos/asdf-vm/asdf/releases/latest | grep -oP '"tag_name":\s*"\K[^"]+'
  args:
    executable: /bin/bash
  register: asdf_version_result
  changed_when: false
  failed_when: false
  when: ansible_facts['os_family'] == 'Debian'

- name: set asdf version from API
  set_fact:
    asdf_version: "{{ asdf_version_result.stdout }}"
  when:
    - ansible_facts['os_family'] == 'Debian'
    - asdf_version_result is defined
    - asdf_version_result.stdout is defined
    - asdf_version_result.stdout | length > 0

- name: check if asdf is already installed
  stat:
    path: /usr/local/bin/asdf
  register: asdf_binary
  when: ansible_facts['os_family'] == 'Debian'

- name: download asdf pre-compiled binary
  get_url:
    url: "https://github.com/asdf-vm/asdf/releases/download/{{ asdf_version }}/asdf_{{ asdf_version }}_linux_amd64.tar.gz"
    dest: "/tmp/asdf_{{ asdf_version }}_linux_amd64.tar.gz"
    mode: '0644'
  when: ansible_facts['os_family'] == 'Debian' and not asdf_binary.stat.exists

- name: extract asdf binary
  unarchive:
    src: "/tmp/asdf_{{ asdf_version }}_linux_amd64.tar.gz"
    dest: /usr/local/bin
    remote_src: true
    creates: /usr/local/bin/asdf
  become: true
  when: ansible_facts['os_family'] == 'Debian' and not asdf_binary.stat.exists

- name: cleanup asdf tarball
  file:
    path: "/tmp/asdf_{{ asdf_version }}_linux_amd64.tar.gz"
    state: absent
  when: ansible_facts['os_family'] == 'Debian' and not asdf_binary.stat.exists

- name: install asdf for Mac
  homebrew:
    name:
      - asdf
  when: ansible_facts['os_family'] == 'Darwin'
